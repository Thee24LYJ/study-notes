[linux 系统设置开机自启脚本方式 \| Thee](https://www.theelyj.com/2023/06/20/linux%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E8%84%9A%E6%9C%AC%E6%96%B9%E5%BC%8F/)
[flask 框架视图函数错误 TypeError: The view function did not return a valid response. -CSDN 博客](https://blog.csdn.net/weixin_44941795/article/details/102817425)
crontab 可视化分析网站：
[Crontab 在线生成器 \| 菜鸟工具](https://www.jyshare.com/front-end/9444/)

# 云服务器配置

### 香橙派服务器

- orangepi2_ip_server.py

遇到的问题：TypeError: The view function did not return a valid response tuple. The tuple must have the form (body, status, headers), (body, status), or (body, headers)
解决：添加返回值

```python
from flask import Flask, request

# 创建orangepi上传ip地址的服务器 使用nginx反向代理
# ip日志文件为/var/log/latest_orangepi_ip.txt
# 已创建systemctl开机自启脚本服务orangepi_ip_reporter.service

app = Flask(__name__)
API_KEY = "orangepi_secret_key_ahgdfkjaghlk"  # 与香橙派脚本中的API_KEY一致

@app.route('/update_ip', methods=['POST'])
def update_ip():
    data = request.json
    if data.get('key') != API_KEY:
        return "Unauthorized", 401
    with open('/var/log/latest_orangepi_ip.txt', 'w') as f:
        f.write(data['ip']+'\n')
    return "OK", 200

@app.route('/update_ip', methods=['GET'])
def get_ip():
    """处理 GET 查询IP"""
    # 验证密钥（通过请求体）
    client_key = request.get_json().get('key')  # 从请求体获取

    if client_key != API_KEY:
        return "Unauthorized", 401

    return "OK", 200

```

### 使用 Gunicorn 启动 Flask 应用

- 安装 Gunicorn

```bash
# 在云服务器上安装
$ pip install gunicorn
```

- 创建/etc/systemd/system/orangepi_ip_reporter.service 文件

```
[Unit]
Description=Gunicorn instance for IP Reporter
After=network.target

[Service]
User=root
WorkingDirectory=/home/thee/code_sources
ExecStart=/usr/local/bin/gunicorn -w 2 -b 127.0.0.1:5000 orangepi2_ip_server:app
Restart=always

[Install]
WantedBy=multi-user.target
```

- 启动 systemd 服务

```bash
$ sudo systemctl start orangepi_ip_reporter
$ sudo systemctl enable orangepi_ip_reporter
$ sudo systemctl daemon-reload
```

### nginx 反向代理

- 创建`/etc/nginx/conf.d/orangepi.conf`文件

```
server {
    listen 80;
    server_name orangepi.theelyj.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name orangepi.theelyj.com;

    ssl_certificate /etc/letsencrypt/live/theelyj.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/theelyj.com/privkey.pem;

    location /update_ip {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

```

# 香橙派配置

### 上传 IP 地址代码

- orangepi_report_ip.py

```python
#!/usr/bin/env python3
import requests
import json
import logging
from datetime import datetime
import socket
import fcntl
import struct

# 读取wlan0的ip地址并上报给云服务器，相关日志文件路径为/var/log/orangepi_report_ip.log
# 已配置crontab定时任务，每天零点自动上传ip地址

# 配置部分
API_URL = "https://orangepi.theelyj.com/update_ip"  # HTTP API 地址
API_KEY = "orangepi_secret_key_ahgdfkjaghlk"  # 认证密钥
NET_INTERFACE = "wlan0"  # 按需改为 eth0/wlan0 等
LOG_FILE = "/var/log/orangepi_report_ip.log"  # 日志文件路径

# 设置日志记录
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE),
        logging.StreamHandler()
    ]
)

def get_ip_address(interface):
    """获取指定网络接口的IP地址"""
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        ip = socket.inet_ntoa(fcntl.ioctl(
            s.fileno(),
            0x8915,  # SIOCGIFADDR
            struct.pack('256s', interface[:15].encode('utf-8'))
        )[20:24])
        return ip
    except Exception as e:
        logging.error(f"获取 {interface} 接口IP失败: {str(e)}")
        return None

def report_ip():
    """上报IP到服务器"""
    # 获取本机IP
    ip_addr = get_ip_address(NET_INTERFACE)
    if not ip_addr:
        return False

    # 生成时间戳
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # 准备上报数据
    data = {
        "ip": ip_addr,
        "timestamp": timestamp,
        "key": API_KEY
    }

    # 上报到服务器
    try:
        response = requests.post(
            API_URL,
            headers={"Content-Type": "application/json"},
            data=json.dumps(data),
            timeout=10  # 设置超时时间
        )

        if response.status_code == 200:
            logging.info(f"IP上报成功: {ip_addr}")
            return True
        else:
            logging.error(f"服务器返回错误: {response.status_code} - {response.t                                                                                                                                  ext}")
            return False

    except requests.exceptions.RequestException as e:
        logging.error(f"请求服务器失败: {str(e)}")
        return False
    except Exception as e:
        logging.error(f"发生未知错误: {str(e)}")
        return False

if __name__ == "__main__":
    # 执行上报
    success = report_ip()

    # 记录到日志文件
    with open(LOG_FILE, 'a') as f:
        status = "成功" if success else "失败"
        log_entry = f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} - {NET_INTE                                                                                                                                  RFACE} IP上报{status}\n"
        f.write(log_entry)
```

### cron 定时服务

- cron 服务配置，执行`crontab -e`命令后配置定时任务：

```bash
# 每天零点定时上传香橙派ip地址到云服务器
0 0 * * * /path/to/orangepi_report_ip.py
```
