[【编译原理】程序运行的四个阶段，从源代码到可执行文件的完整过程解析-CSDN 博客](https://blog.csdn.net/weixin_63050691/article/details/138452220)
[强上 Linux 内核 3--一个程序从开始运行到结束的完整过程，你能说出来多少？](https://blog.csdn.net/weixin_45785536/article/details/122839395)

![](https://s2.loli.net/2024/08/08/U86uvRIiNA3sCVD.gif)

# 一、编译链接过程

- 预编译（预编译器处理如  `#include`、`#define`  和`ifdef`等预编译指令，生成  `.i`  或  `.ii`  文件） -> `gcc -E test.c -o test.i`
- 编译（编译器进行词法分析、语法分析、语义分析、中间代码生成、目标代码生成、优化，生成  `.s`  文件） -> `gcc -S test.i -o test.s`
- 汇编（汇编器把汇编码翻译成机器码，生成  `.o`  文件） -> `as test.s -o test.o`
- 链接（链接器进行地址和空间分配、符号决议、重定位，生成  `.out`  文件） -> `gcc test.o -o a.out`

# 二、编译器优化等级

[【gcc】gcc 优化等级 -O1 -O2 -O3 -Os -Ofast -Og|gcc 关闭优化-CSDN 博客](https://blog.csdn.net/bandaoyu/article/details/123700034)
[细节改善效率：论 g++编译优化选项有多重要-CSDN 博客](https://blog.csdn.net/weixin_39703605/article/details/106159132)

对于 GNU 编译器来说，存在不同的优化等级，如-O0、-O2、-O3、-Og 等，-O0 基本不会对程序进行优化，此时可以使用 GDB 进行调试，但是-O0 编译器仍然会进行一些些优化的

# 三、目标文件存储结构

| 段                      | 功能                                                                                                                  |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------- |
| File Header             | 文件头，描述整个文件的文件属性（包括文件是否可执行、是静态链接或动态链接及入口地址、目标硬件、目标操作系统等）        |
| .text section           | 代码段，执行语句编译成的机器代码                                                                                      |
| .data section           | 数据段，已初始化的全局变量和局部静态变量                                                                              |
| .bss section            | BSS 段（Block Started by Symbol），未初始化的全局变量和局部静态变量（因为默认值为 0，所以只是在此预留位置，不占空间） |
| .rodata section         | 只读数据段，存放只读数据，一般是程序里面的只读变量（如 const 修饰的变量）和字符串常量                                 |
| .comment section        | 注释信息段，存放编译器版本信息                                                                                        |
| .note.GNU-stack section | 堆栈提示段                                                                                                            |

# 四、gcc 编译参数

[GCC \| 爱编程的大丙](https://subingwen.cn/linux/gcc/)

|               gcc 编译选项               | 选项的意义                                                                                       |
| :--------------------------------------: | :----------------------------------------------------------------------------------------------- |
|                    -E                    | 预处理指定的源文件，不进行编译                                                                   |
|                    -S                    | 编译指定的源文件，但是不进行汇编                                                                 |
|                    -c                    | 编译、汇编指定的源文件，但是不进行链接                                                           |
| -o [file1] [file2] 或 [file2] -o [file1] | 将文件 file2 编译成文件 file1                                                                    |
|         -I directory (大写的 i)          | 指定 include 包含文件的搜索目录                                                                  |
|                    -g                    | 在编译的时候，生成调试信息，该程序可以被调试器调试                                               |
|                    -D                    | 在程序编译的时候，指定一个宏                                                                     |
|                    -w                    | 不生成任何警告信息, 不建议使用, 有些时候警告就是错误                                             |
|                  -Wall                   | 生成所有警告信息                                                                                 |
|                   -On                    | n 的取值范围：0~3。编译器的优化选项的 4 个级别，-O0 表示没有优化，-O1 为缺省值，-O3 优化级别最高 |
|                    -l                    | 在程序编译的时候，指定使用的库                                                                   |
|                    -L                    | 指定编译的时候，搜索的库的路径。                                                                 |
|                -fPIC/fpic                | 生成与位置无关的代码                                                                             |
|                 -shared                  | 生成共享目标文件。通常用在建立共享库时                                                           |
|                   -std                   | 指定 C 方言，如:-std=c99，gcc 默认的方言是 GNU C                                                 |

示例如下：

```bash
# 在编译的时候重新指定头文件位置 -I 头文件目录
$ gcc *.c -o test -I ./include
# 指定一个宏DEBUG
$ gcc test.c -o test -D DEBUG
```

gcc 与 g++区别：

- 不管是 gcc 还是 g++ 都可以编译 C 程序，编译程序的规则和参数都相同
- g++可以直接编译 C++程序， gcc 编译 C++程序需要添加额外参数 -lstdc++
- 不管是 gcc 还是 g++ 都可以定义 \_\_cplusplus 宏
